import random
import logging
import json
from datetime import datetime, timedelta
from telegram import Update
from telegram.ext import (
    ApplicationBuilder, CommandHandler, ContextTypes,
    MessageHandler, filters, JobQueue
)

# === CONFIG ===
BOT_TOKEN = "8007679799:AAGekKeFh9L9oWLI35ieOM3ENjCxCKofJow"
ADMIN_CHAT_ID = "-4618714192"  # Chat ID where you want logs
PARTICIPANT_FILE = "participan.json"  # Stores unique participant numbers

# === STATE ===
participants = {}  # chat_id -> data

# === UTILS ===
def load_participants():
    try:
        with open(PARTICIPANT_FILE, "r") as f:
            return json.load(f)
    except FileNotFoundError:
        return {}

def save_participants(data):
    with open(PARTICIPANT_FILE, "w") as f:
        json.dump(data, f, indent=2)

# Generate a unique participant ID
def generate_unique_number(existing_ids):
    while True:
        number = f"P{random.randint(1000, 9999)}"
        if number not in existing_ids:
            return number

# === START COMMAND ===
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    chat_id = update.effective_chat.id
    participants_data = load_participants()

    if str(chat_id) in participants_data:
        await context.bot.send_message(chat_id=chat_id, text="–í–∏ –≤–∂–µ –∑–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω—ñ!")
        return

    new_id = generate_unique_number([p["id"] for p in participants_data.values()])
    participants_data[str(chat_id)] = {
        "id": new_id,
        "joined_at": datetime.now().isoformat(),
        "task_done": False,
        "second_task_done": False  # Track second task status
    }
    save_participants(participants_data)

    await context.bot.send_message(chat_id=chat_id, text=f"–ü—Ä–∏–≤—ñ—Ç! –í–∞—à –∞–Ω–æ–Ω—ñ–º–Ω–∏–π –Ω–æ–º–µ—Ä —É—á–∞—Å–Ω–∏–∫–∞: {new_id}")

    # Notify admin
    await context.bot.send_message(chat_id=ADMIN_CHAT_ID, text=f"‚úÖ –£—á–∞—Å–Ω–∏–∫ {new_id} –ø—Ä–∏—î–¥–Ω–∞–≤—Å—è.")

    # Schedule test message and task reminder
    context.job_queue.run_once(send_test_message, when=5, chat_id=chat_id)  # 5 seconds for test message
    context.job_queue.run_once(ask_if_done, when=20, chat_id=chat_id)  # 20 seconds for task reminder

# === SEND TEST MESSAGE ===
async def send_test_message(context: ContextTypes.DEFAULT_TYPE):
    chat_id = context.job.chat_id
    await context.bot.send_message(chat_id=chat_id, text="""\
–í—ñ—Ç–∞—é! –î—è–∫—É—é –∑–∞ —É—á–∞—Å—Ç—å —É —Ü—å–æ–º—É –¥–æ—Å–ª—ñ–¥–∂–µ–Ω–Ω—ñ!

–ù–∞ —Ü—ñ–π —Å—Ç–æ—Ä—ñ–Ω—Ü—ñ –í–∏ –∑–º–æ–∂–µ—Ç–µ –ø—Ä–æ—á–∏—Ç–∞—Ç–∏ –∫–æ—Ä–æ—Ç–∫–∏–π –æ–ø–∏—Å –¥–æ—Å–ª—ñ–¥–∂–µ–Ω–Ω—è —Ç–∞ —Ç–µ, —â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ –≤–∏–∫–æ–Ω–∞—Ç–∏ –ø–µ—Ä—à –Ω—ñ–∂ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç–∏ –¥–æ —Å–∞–º–æ–≥–æ –∑–∞–≤–¥–∞–Ω–Ω—è.

–£ —Ü—å–æ–º—É –¥–æ—Å–ª—ñ–¥–∂–µ–Ω–Ω—ñ –í–∞–º –±—É–¥–µ –ø–æ—Ç—Ä—ñ–±–Ω–æ –ø–∏—Å–∞—Ç–∏ –Ω–∞ –æ–¥–Ω—É —ñ–∑ –∑–∞–¥–∞–Ω–∏—Ö —Ç–µ–º 15 —Ö–≤–∏–ª–∏–Ω —Ç–∞ –∑–∞–ø–æ–≤–Ω–∏—Ç–∏ –∞–Ω–∫–µ—Ç—É –¥–æ —ñ –ø—ñ—Å–ª—è –µ–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç—É. –£—Å—ñ –¥–∞–Ω—ñ –±—É–¥—É—Ç—å –∫–æ–Ω—Ñ—ñ–¥–µ–Ω—Ü—ñ–π–Ω–∏–º–∏, –∞ –í–∞—à—ñ –∑–∞–ø–∏—Å–∏ –±—É–¥—É—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ñ –ª–∏—à–µ –í–∞–º.

–ü–µ—Ä–µ–¥ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è–º –∑–∞–≤–¥–∞–Ω—å, –±—É–¥—å –ª–∞—Å–∫–∞:
‚Ä¢ –ó–∞–ø–æ–≤–Ω—ñ—Ç—å —Ü–µ –æ–ø–∏—Ç—É–≤–∞–Ω–Ω—è (https://docs.google.com/forms/d/e/1FAIpQLSdqW48eEaLW27ax2iQ-NfXQ2VT1Uw-7cNlPzVeqEfH5Lgcetg/viewform?usp=header)
‚Ä¢ –ó–≤–µ—Ä–Ω—ñ—Ç—å —É–≤–∞–≥—É, —â–æ —Ü—è —Ç–µ—Ö–Ω—ñ–∫–∞ –º–æ–∂–µ –±—É—Ç–∏ –¥–æ—Å–∏—Ç—å –µ–º–æ—Ü—ñ–π–Ω–æ—é, —ñ –¥–µ—è–∫—ñ –ª—é–¥–∏ –ø–ª–∞–∫–∞–ª–∏ –ø—ñ–¥ —á–∞—Å —ó—ó –≤–∏–∫–æ–Ω–∞–Ω–Ω—è
‚Ä¢ –ö—Ä–∞—â–µ –º–∞—Ç–∏ —Ü—ñ —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—ó –ø—ñ–¥ —Ä—É–∫–æ—é –ø—ñ–¥ —á–∞—Å –µ–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç—É.

–í–ê–ñ–õ–ò–í–û: –±—É–¥—å –ª–∞—Å–∫–∞, –Ω–µ –æ–±–≥–æ–≤–æ—Ä—é–π—Ç–µ –Ω—ñ –∑ –∫–∏–º –ø–∏—Å—å–º–æ–≤—É —Ç–µ—Ö–Ω—ñ–∫—É —Ç–∞ –¥–µ—Ç–∞–ª—ñ —Å–≤–æ—ó—Ö —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ–π.
""")

# === ASK IF DONE ===
async def ask_if_done(context: ContextTypes.DEFAULT_TYPE):
    chat_id = context.job.chat_id
    await context.bot.send_message(
        chat_id=chat_id,
        text="–ß–∏ –≤–∏–∫–æ–Ω–∞–ª–∏ –≤–∏ –ø–µ—Ä—à–µ –æ–ø–∏—Ç—É–≤–∞–Ω–Ω—è? (–í—ñ–¥–ø–æ–≤—ñ–¥–∞–π—Ç–µ: —Ç–∞–∫ / –Ω—ñ)"
    )

# === HANDLE TEXT REPLIES ("—Ç–∞–∫"/"–Ω—ñ") ===
async def handle_text(update: Update, context: ContextTypes.DEFAULT_TYPE):
    text = update.message.text.lower()
    chat_id = update.effective_chat.id
    participants_data = load_participants()
    user = participants_data.get(str(chat_id), None)

    if not user:
        return

    # Check for task completion phrases
    task_numbers = {
        "–æ–¥–∏–Ω": 1, "–ø–µ—Ä—à–µ": 1, "1": 1,
        "–¥–≤–∞": 2, "–¥—Ä—É–≥–µ": 2, "2": 2,
        "—Ç—Ä–∏": 3, "—Ç—Ä–µ—Ç—î": 3, "3": 3,
        "—á–æ—Ç–∏—Ä–∏": 4, "—á–µ—Ç–≤–µ—Ä—Ç–µ": 4, "4": 4
    }

    if any(phrase in text.lower() for phrase in ["–≤–∏–∫–æ–Ω–∞–ª–∞ –∑–∞–≤–¥–∞–Ω–Ω—è", "–≤–∏–∫–æ–Ω–∞–≤ –∑–∞–≤–¥–∞–Ω–Ω—è"]):
        for word, task_num in task_numbers.items():
            if word in text.lower():
                join_date = datetime.fromisoformat(user['joined_at'])
                is_new_user = (datetime.now() - join_date).days <= 1

                # Notify admin about task completion
                await context.bot.send_message(
                    chat_id=ADMIN_CHAT_ID, 
                    text=f"‚úÖ –£—á–∞—Å–Ω–∏–∫ {user['id']} –≤–∏–∫–æ–Ω–∞–≤ –∑–∞–≤–¥–∞–Ω–Ω—è {task_num}"
                )

                # Send group-specific completion message only for the first task
                if task_num == 1:
                    await context.bot.send_message(
                        chat_id=chat_id,
                        text="–î—è–∫—É—é –∑–∞ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è —Å—å–æ–≥–æ–¥–Ω—ñ—à–Ω—å–æ–≥–æ –∑–∞–≤–¥–∞–Ω–Ω—è! –ó–∞–≤—Ç—Ä–∞ –í–∞–º –±—É–¥–µ –Ω–∞–¥—ñ—Å–ª–∞–Ω–æ –Ω–∞—Å—Ç—É–ø–Ω—ñ —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—ó. –î–æ –∑—É—Å—Ç—Ä—ñ—á—ñ!"
                    )

                # Handle task scheduling for new users after the fourth task
                if task_num == 4 and is_new_user:
                    context.job_queue.run_once(
                        send_second_questionnaire,
                        when=timedelta(days=14),
                        chat_id=chat_id
                    )

                save_participants(participants_data)
                return

    # Handle answer "—Ç–∞–∫" for first task completion
    if "—Ç–∞–∫" in text:
        if user.get("task_done") is False:
            user["task_done"] = True

            # Check if user is new
            join_date = datetime.fromisoformat(user['joined_at'])
            is_new_user = (datetime.now() - join_date).days <= 1

            await context.bot.send_message(
                chat_id=ADMIN_CHAT_ID,
                text=f"‚úÖ –£—á–∞—Å–Ω–∏–∫ {user['id']} –ø–æ–≤—ñ–¥–æ–º–∏–≤ –ø—Ä–æ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –∑–∞–≤–¥–∞–Ω–Ω—è"
            )

            # Randomly assign to group A or B and send corresponding messages
            if is_new_user:
                group = random.choice(['A', 'B'])
                user['group'] = group

                # Send initial instructions
                prep_text = """–ó–Ω–∞–π–¥—ñ—Ç—å —Ç–∏—Ö–µ –º—ñ—Å—Ü–µ, –¥–µ –í–∞—Å –Ω—ñ—Ö—Ç–æ –Ω–µ –ø–æ—Ç—É—Ä–±—É—î –ø—Ä–æ—Ç—è–≥–æ–º 15-30 —Ö–≤–∏–ª–∏–Ω. –ü—ñ–¥–≥–æ—Ç—É–π—Ç–µ –ø–∞–ø—ñ—Ä —ñ —Ä—É—á–∫—É, –∞–±–æ –≤–∞—à –ø–ª–∞–Ω—à–µ—Ç —á–∏ –Ω–æ—É—Ç–±—É–∫ (—è–∫—â–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç–µ –µ–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ñ –ø—Ä–∏—Å—Ç—Ä–æ—ó, —É–≤—ñ–º–∫–Ω—ñ—Ç—å –∞–≤—ñ–∞—Ä–µ–∂–∏–º, —â–æ–± —É–Ω–∏–∫–Ω—É—Ç–∏ –≤—ñ–¥–≤–æ–ª—ñ–∫–∞–Ω—å).
‚Ä¢ –ü–æ—Å—Ç–∞–≤—Ç–µ —Ç–∞–π–º–µ—Ä –Ω–∞ 15 —Ö–≤–∏–ª–∏–Ω. –Ø–∫—â–æ –≤–≤–∞–∂–∞—î—Ç–µ –∑–∞ –ø–æ—Ç—Ä—ñ–±–Ω–µ, –í–∏ –º–æ–∂–µ—Ç–µ –ø—Ä–æ–¥–æ–≤–∂—É–≤–∞—Ç–∏ –ø–∏—Å–∞—Ç–∏ —ñ –ø—ñ—Å–ª—è –¥–∑–≤—ñ–Ω–∫–∞ —Ç–∞–π–º–µ—Ä–∞.
‚Ä¢ –ö–æ–ª–∏ –ø–æ—á–Ω–µ—Ç–µ –ø–∏—Å–∞—Ç–∏, –Ω–µ –∑—É–ø–∏–Ω—è–π—Ç–µ—Å—è, —Ö—ñ–±–∞ —â–æ –í–∞–º –±—É–¥–µ –∑–æ–≤—Å—ñ–º –≤–∞–∂–∫–æ –µ–º–æ—Ü—ñ–π–Ω–æ."""

                await context.bot.send_message(chat_id=chat_id, text=prep_text)

                # Send group-specific instructions
                task_text = """–û–±–µ—Ä—ñ—Ç—å –æ–¥–Ω—É —ñ–∑ –∑–∞–ø—Ä–æ–ø–æ–Ω–æ–≤–∞–Ω–∏—Ö —Ç–µ–º —Ç–∞ –ø–æ—á–∏–Ω–∞–π—Ç–µ –ø–∏—Å–∞—Ç–∏, –Ω–µ –≤—ñ–¥–≤–æ–ª—ñ–∫–∞—é—á–∏—Å—å.
                ‚Ä¢ –î–µ—Ç–∞–ª—å–Ω–æ –æ–ø–∏—à—ñ—Ç—å, —â–æ –≤–∏ –∑—Ä–æ–±–∏–ª–∏ –∑ —Ç–æ–≥–æ —á–∞—Å—É, —è–∫ –ø—Ä–æ–∫–∏–Ω—É–ª–∏—Å—è —Å—å–æ–≥–æ–¥–Ω—ñ –≤—Ä–∞–Ω—Ü—ñ.
                ‚Ä¢ –î–µ—Ç–∞–ª—å–Ω–æ –æ–ø–∏—à—ñ—Ç—å –≤–∞—à—ñ –ø–ª–∞–Ω–∏ –Ω–∞ —Å—å–æ–≥–æ–¥–Ω—ñ—à–Ω—ñ–π –¥–µ–Ω—å. 
                ‚Ä¢ –î–µ—Ç–∞–ª—å–Ω–æ –æ–ø–∏—à—ñ—Ç—å –æ—Å—Ç–∞–Ω–Ω—é –ø–æ–¥—ñ—é –∞–±–æ –∑–∞—Ö—ñ–¥, —è–∫—ñ –≤–∏ –≤—ñ–¥–≤—ñ–¥—É–≤–∞–ª–∏. 
                ‚Ä¢ –î–µ—Ç–∞–ª—å–Ω–æ –æ–ø–∏—à—ñ—Ç—å –±—É–¥—å-—è–∫–∏–π –ø—Ä–µ–¥–º–µ—Ç, —è–∫–∏–π –≤–∏ –±–∞—á–∏—Ç–µ –Ω–∞–≤–∫–æ–ª–æ —Å–µ–±–µ —á–∏ –≥–∞—Ä–Ω–æ –≤—ñ–¥–æ–º—É –≤–∞–º –±—É–¥—ñ–≤–ª—é. 
                ‚Ä¢ –î–µ—Ç–∞–ª—å–Ω–æ —Ä–æ–∑–ø–∏—à—ñ—Ç—å —è–∫ –ø—Ä–∏–≥–æ—Ç—É–≤–∞—Ç–∏ –∫–∞–≤—É –∑ –Ω—É–ª—è
                –í–∞–∂–ª–∏–≤–æ, —â–æ–± –≤–∏ –æ–ø–∏—Å—É–≤–∞–ª–∏ –ø–æ–¥—ñ—ó —Å–∞–º–µ —Ç–∞–∫, —è–∫ –≤–æ–Ω–∏ –≤—ñ–¥–±—É–≤–∞–ª–∏—Å—è. –ù–µ –∑–≥–∞–¥—É–π—Ç–µ –≤–ª–∞—Å–Ω—ñ –µ–º–æ—Ü—ñ—ó, –ø–æ—á—É—Ç—Ç—è —á–∏ –¥—É–º–∫–∏. –ù–∞–º–∞–≥–∞–π—Ç–µ—Å—è –±—É—Ç–∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –æ–±‚Äô—î–∫—Ç–∏–≤–Ω–∏–º–∏.
                –ü—ñ—Å–ª—è —Ç–æ–≥–æ, —è–∫ –ø–æ—á–∞–ª–∏ –ø–∏—Å–∞—Ç–∏, –Ω–µ –∑—É–ø–∏–Ω—è–π—Ç–µ—Å—è. –ù–µ –∑–≤–∞–∂–∞–π—Ç–µ –Ω–∞ –ø–æ–º–∏–ª–∫–∏, –≥—Ä–∞–º–æ—Ç–Ω—ñ—Å—Ç—å, —á–∏ —Å—é–∂–µ—Ç —ñ—Å—Ç–æ—Ä—ñ–π. –Ø–∫—â–æ –∑–∞–∫—ñ–Ω—á–∏–ª–∏—Å—è –Ω–æ–≤—ñ —ñ–¥–µ—ó, –ø—Ä–æ—Å—Ç–æ –ø–æ–≤—Ç–æ—Ä—é–π—Ç–µ —Ç–µ, —â–æ –≤–∂–µ –Ω–∞–ø–∏—Å–∞–ª–∏. –ü–∏—à—ñ—Ç—å –ø–æ–≤–Ω–∏–º–∏ —Ä–µ—á–µ–Ω–Ω—è–º–∏, –Ω–∞–≤—ñ—Ç—å —è–∫—â–æ –≤–æ–Ω–∏ –Ω–µ —ñ–¥–µ–∞–ª—å–Ω—ñ. –ù—ñ—Ö—Ç–æ, –∫—Ä—ñ–º –≤–∞—Å, –Ω–µ —á–∏—Ç–∞—Ç–∏–º–µ —Ü—å–æ–≥–æ."""
                await context.bot.send_message(chat_id=chat_id, text=task_text)

                # Closing message
                closing_text = """–ó–∞–∫—Ä–∏–π—Ç–µ –∑–æ—à–∏—Ç —á–∏ –¥–æ–∫—É–º–µ–Ω—Ç, –≤ —è–∫–æ–º—É –ø–∏—Å–∞–ª–∏, —ñ –≤—ñ–¥–∫–ª–∞–¥—ñ—Ç—å –π–æ–≥–æ. –Ø–∫—â–æ —Ç—Ä–µ–±–∞, –º–æ–∂–Ω–∞ –∫—ñ–ª—å–∫–∞ —Ö–≤–∏–ª–∏–Ω –ø–æ—Å–∏–¥—ñ—Ç–∏, —â–æ–± –∑–∞—Å–ø–æ–∫–æ—ó—Ç–∏—Å—è. –Ø–∫—â–æ –≤–∞–º —Å—É–º–Ω–æ, —Ü–µ –Ω–æ—Ä–º–∞–ª—å–Ω–æ, –∑–∞–∑–≤–∏—á–∞–π —Ü–µ –º–∏–Ω–∞—î –∑–∞ –∫—ñ–ª—å–∫–∞ –≥–æ–¥–∏–Ω, —è–∫ –ø—ñ—Å–ª—è –ø–µ—Ä–µ–≥–ª—è–¥—É —Å—É–º–Ω–æ–≥–æ —Ñ—ñ–ª—å–º—É."""

                await context.bot.send_message(chat_id=chat_id, text=closing_text)

            else:
                await context.bot.send_message(chat_id=chat_id, text="–ß—É–¥–æ–≤–æ! –û—á—ñ–∫—É–π—Ç–µ —ñ–Ω—à—ñ —É—á–∞—Å–Ω–∏–∫—ñ–≤.")

        save_participants(participants_data)

    elif "–Ω—ñ" in text:
        if user.get("task_done") is False:
            await context.bot.send_message(chat_id=chat_id, text="–ë—É–¥—å –ª–∞—Å–∫–∞, –ø–æ–≤–µ—Ä–Ω—ñ—Ç—å—Å—è –¥–æ –≥—É–≥–ª —Ñ–æ—Ä–º–∏ —Ç–∞ –∑–∞–ø–æ–≤–Ω—ñ—Ç—å —ó—ó.")
            context.job_queue.run_once(ask_if_done, when=40, chat_id=chat_id)  # Ask again after 40 seconds


# === MANUAL TASK ASSIGNMENT ===
async def assign(update: Update, context: ContextTypes.DEFAULT_TYPE):
    args = context.args
    if len(args) < 2:
        await update.message.reply_text("–í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è: /assign P1234 —Ç–µ–∫—Å—Ç_–ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è")
        return

    participant_id = args[0]
    message_text = " ".join(args[1:])

    participants_data = load_participants()
    for chat_id, data in participants_data.items():
        if data["id"] == participant_id:
            await context.bot.send_message(chat_id=int(chat_id), text=message_text)
            await update.message.reply_text(f"‚úÖ –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –Ω–∞–¥—ñ—Å–ª–∞–Ω–æ –¥–æ {participant_id}")
            return

    await update.message.reply_text("‚ùå –£—á–∞—Å–Ω–∏–∫ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–∏–π.")

# === REMOVE YOURSELF ===
async def clear_me(update: Update, context: ContextTypes.DEFAULT_TYPE):
    chat_id = update.effective_chat.id  # Get the chat ID of the user
    participants_data = load_participants()  # Load the participants data

    # Check if the user is in the participants list
    if str(chat_id) in participants_data:
        del participants_data[str(chat_id)]  # Remove the participant
        save_participants(participants_data)  # Save the updated data back to the file
        await update.message.reply_text("‚úÖ –í–∏ –±—É–ª–∏ –≤–∏–¥–∞–ª–µ–Ω—ñ –∑ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó.")
    else:
        await update.message.reply_text("‚ùå –í–∏ –Ω–µ –∑–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω—ñ —É —Å–∏—Å—Ç–µ–º—ñ.")

# === BROADCAST TO MULTIPLE USERS ===
async def broadcast(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if str(update.effective_chat.id) != ADMIN_CHAT_ID:
        return  # Only admin can broadcast
    
    if len(context.args) < 2:
        await update.message.reply_text("–í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è: /broadcast P1234,P5678 —Ç–µ–∫—Å—Ç_–ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è")
        return

    # First argument is comma-separated list of participant IDs
    participant_ids = context.args[0].split(',')
    message_text = " ".join(context.args[1:])
    
    participants_data = load_participants()
    delivery_status = {}
    
    # Send messages and track status for each participant
    for chat_id, data in participants_data.items():
        if data["id"] in participant_ids:
            try:
                await context.bot.send_message(chat_id=int(chat_id), text=message_text)
                delivery_status[data["id"]] = "‚úÖ –î–æ—Å—Ç–∞–≤–ª–µ–Ω–æ"
            except Exception as e:
                delivery_status[data["id"]] = f"‚ùå –ü–æ–º–∏–ª–∫–∞: {str(e)}"
    
    # Create detailed report
    status_report = "üì¨ –°—Ç–∞—Ç—É—Å –¥–æ—Å—Ç–∞–≤–∫–∏:\n\n"
    for p_id in participant_ids:
        status = delivery_status.get(p_id, "‚ùå –£—á–∞—Å–Ω–∏–∫–∞ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ –≤ —Å–∏—Å—Ç–µ–º—ñ")
        status_report += f"{p_id}: {status}\n"
    
    await update.message.reply_text(status_report)

# === BOT APP ===
def main():
    app = ApplicationBuilder().token(BOT_TOKEN).build()

    # Add handlers
    app.add_handler(CommandHandler("start", start))
    app.add_handler(CommandHandler("assign", assign))  # The assign command
    app.add_handler(CommandHandler("clearme", clear_me))  # Add the clear_me handler
    app.add_handler(CommandHandler("broadcast", broadcast))  # Add the broadcast handler
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_text))

    print("ü§ñ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω–æ!")
    app.run_polling()

if __name__ == "__main__":
    main()
